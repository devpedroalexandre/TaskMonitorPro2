<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>TaskMonitor Pro 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      transition: background-color 0.3s, color 0.3s;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    body.dark-mode {
      background-color: #121212;
      background: #121212;
      color: #f1f1f1;
    }
    .container {
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }
    .dark-mode .container {
      background-color: #1e1e1e;
      border-radius: 10px;
    }
    .dark-mode .list-group-item {
      background-color: #1e1e1e;
      color: #f1f1f1;
      border-color: #333;
    }
    .dark-mode .btn {
      color: #f1f1f1 !important;
      border-color: #f1f1f1 !important;
    }
    .dark-mode .card {
      background-color: #1e1e1e;
      border-color: #333;
    }
    .dark-mode .card-header {
      background-color: #0d6efd !important;
      border-color: #333;
    }
    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(255, 255, 255, 0.9) !important;
      color: #333 !important;
      border: 2px solid #333 !important;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    .dark-mode .theme-toggle {
      background-color: rgba(255, 255, 255, 0.95) !important;
      color: #000 !important;
      border: 2px solid #fff !important;
    }
    .theme-toggle:hover {
      background-color: rgba(255, 255, 255, 1) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .btn-nav {
      background-color: rgba(255, 255, 255, 0.7);
      color: #333;
      border: 2px solid #333;
      padding: 8px 16px;
      transition: all 0.3s;
      font-weight: 600;
    }
    
    .btn-nav:hover {
      background-color: rgba(255, 255, 255, 0.9);
      border-color: #000;
      color: #000;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .btn-nav.active {
      background-color: #0d6efd;
      border-color: #0d6efd;
      color: white !important;
    }
    
    .dark-mode .btn-nav {
      background-color: rgba(255, 255, 255, 0.1);
      color: #f1f1f1;
      border-color: #6c757d;
      font-weight: 600;
    }
    
    .dark-mode .btn-nav:hover {
      background-color: rgba(255, 255, 255, 0.2);
      border-color: #adb5bd;
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
    }
    
    .dark-mode .btn-nav.active {
      background-color: #0d6efd;
      border-color: #0d6efd;
      color: white !important;
    }
    
    .processo-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin-bottom: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    }
    .dark-mode .processo-item {
      background-color: #2a2a2a;
      background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
      border-color: #555;
      border-width: 1px;
    }
    .processo-info {
      flex: 1;
      margin-right: 15px;
      min-width: 200px;
    }
    .processo-grafico {
      width: 350px;
      height: 70px;
      margin-right: 15px;
    }
    .processo-nome {
      font-weight: bold;
      font-size: 14px;
    }
    .processo-detalhes {
      font-size: 12px;
      color: #6c757d;
      margin-top: 4px;
    }
    .dark-mode .processo-detalhes {
      color: #adb5bd;
    }
    
    .badge-cpu-high {
      background-color: #dc3545 !important;
      font-size: 11px;
    }
    .badge-mem-high {
      background-color: #fd7e14 !important;
      font-size: 11px;
    }
    
    .status-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .status-card {
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .status-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
    .dark-mode .status-card {
      background-color: #2a2a2a;
      background: #2a2a2a;
      border-color: #444;
      box-shadow: none;
    }
    .dark-mode .status-card:hover {
      transform: none;
      box-shadow: none;
    }
    .status-label {
      font-size: 12px;
      color: #6c757d;
      text-transform: uppercase;
    }
    .dark-mode .status-label {
      color: #adb5bd;
    }
    .status-value {
      font-size: 24px;
      font-weight: bold;
      margin-top: 8px;
    }
    
    .btn-filtro.active {
      background-color: #0d6efd !important;
      color: white !important;
      border-color: #0d6efd !important;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <button class="btn btn-outline-secondary theme-toggle" onclick="alternarTema()">üåô Tema</button>
    <h1 class="text-center mb-4">üñ•Ô∏è TaskMonitor Pro 2</h1>

    <div class="row text-center mb-4">
      <div class="col-md-3"><h4>CPU</h4><p class="fs-4" id="cpu-main">%</p></div>
      <div class="col-md-3"><h4>Mem√≥ria</h4><p class="fs-4" id="memoria-main">%</p></div>
      <div class="col-md-3"><h4>Disco</h4><p class="fs-4" id="disco-main">%</p></div>
      <div class="col-md-3"><h4>Status</h4><p class="fs-4" id="status-main">-</p></div>
    </div>

    <div class="text-center mt-4">
      <button class="btn btn-nav me-2" id="btn-status" onclick="mostrarPainel('status')">Status</button>
      <button class="btn btn-nav me-2" id="btn-rede" onclick="mostrarPainel('rede')">Rede</button>
      <button class="btn btn-nav me-2" id="btn-hardware" onclick="mostrarPainel('hardware')">Hardware</button>
      <button class="btn btn-nav me-2" id="btn-processos" onclick="mostrarPainel('processos')">Processos</button>
      <button class="btn btn-nav me-2" id="btn-uptime" onclick="mostrarPainel('uptime')">Uptime</button>
      <button class="btn btn-nav me-2" id="btn-backup" onclick="executarBackup()">Criar Backup</button>
      <button class="btn btn-nav" id="btn-logs" onclick="mostrarPainel('logs')">Logs</button>
    </div>

    <div id="painel-backup" class="mt-4 text-center" style="display:none;">
      <p id="mensagem-backup" class="fw-bold"></p>
    </div>

    <div id="painel-status" class="mt-4" style="display:none;">
      <h4>üìä Status do Sistema</h4>
      <div class="status-row" id="status-cards"></div>
    </div>

    <div id="painel-logs" class="mt-4" style="display:none;">
      <h4>üìã Logs de Backup</h4>
      <ul id="logs-list" class="list-group"></ul>
    </div>

    <div id="painel-processos" class="mt-4" style="display:none;">
      <h4>‚öôÔ∏è Processos</h4>
      <div class="mb-3">
        <button class="btn btn-sm btn-outline-secondary btn-filtro" id="btn-filtro-cpu" onclick="filtrarProcessos('cpu')">Top CPU</button>
        <button class="btn btn-sm btn-outline-secondary btn-filtro" id="btn-filtro-memoria" onclick="filtrarProcessos('memoria')">Top Mem√≥ria</button>
        <button class="btn btn-sm btn-outline-secondary btn-filtro" id="btn-filtro-todos" onclick="filtrarProcessos('todos')">Todos</button>
      </div>
      <div id="processos-list"></div>
    </div>

    <div id="painel-rede" class="mt-4" style="display:none;">
      <h4>üåê Rede</h4>
      <ul id="rede-list" class="list-group"></ul>
      <div class="card mt-4">
        <div class="card-header bg-primary text-white">
          <h5>üìä Oscila√ß√£o de Rede em Tempo Real</h5>
        </div>
        <div class="card-body">
          <canvas id="redeChart" width="400" height="100"></canvas>
        </div>
      </div>
    </div>

    <div id="painel-hardware" class="mt-4" style="display:none;">
      <h4>üñ≤Ô∏è Hardware</h4>
      <ul id="hardware-list" class="list-group"></ul>
    </div>

    <div id="painel-uptime" class="mt-4" style="display:none;">
      <h4>‚è±Ô∏è Uptime</h4>
      <ul id="uptime-list" class="list-group"></ul>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    function alternarTema() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('tema', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    function removerAtivo() {
      document.querySelectorAll('.btn-nav').forEach(btn => btn.classList.remove('active'));
    }

    function esconderTodos() {
      document.querySelectorAll('[id^="painel-"]').forEach(p => p.style.display = 'none');
      if (window.intervaloGraficoRede) {
        clearInterval(window.intervaloGraficoRede);
        window.intervaloGraficoRede = null;
      }
    }

    window.addEventListener('load', function() {
      if (localStorage.getItem('tema') === 'dark') {
        document.body.classList.add('dark-mode');
      }
      atualizarDashboard();
      setInterval(atualizarDashboard, 3000);
      mostrarPainel('status');
    });

    function atualizarDashboard() {
      fetch('/status')
        .then(res => res.json())
        .then(data => {
          // Atualiza o dashboard com dados reais
          document.getElementById('cpu-main').textContent = data.cpu ? data.cpu + '%' : '%';
          document.getElementById('memoria-main').textContent = data.memoria ? data.memoria + '%' : '%';
          document.getElementById('disco-main').textContent = data.disco ? data.disco + '%' : '%';
          document.getElementById('status-main').textContent = data.status_servidor || '-';
        })
        .catch(err => {
          console.error('Erro ao atualizar dashboard:', err);
          // Em caso de erro, mant√©m o placeholder
          document.getElementById('cpu-main').textContent = '%';
          document.getElementById('memoria-main').textContent = '%';
          document.getElementById('disco-main').textContent = '%';
          document.getElementById('status-main').textContent = '-';
        });
    }

    function executarBackup() {
      removerAtivo();
      esconderTodos();
      document.getElementById('btn-backup').classList.add('active');
      
      fetch('/backup')
        .then(res => res.text())
        .then(msg => {
          document.getElementById('mensagem-backup').textContent = msg;
          document.getElementById('painel-backup').style.display = 'block';
        });
    }

    function mostrarPainel(tipo) {
      removerAtivo();
      esconderTodos();
      document.getElementById(`btn-${tipo}`).classList.add('active');

      if (tipo === 'status') {
        fetch('/status').then(res => res.json()).then(data => {
          let html = `
            <div class="status-card">
              <div class="status-label">CPU</div>
              <div class="status-value">${data.cpu}%</div>
            </div>
            <div class="status-card">
              <div class="status-label">Mem√≥ria</div>
              <div class="status-value">${data.memoria}%</div>
            </div>
            <div class="status-card">
              <div class="status-label">Disco</div>
              <div class="status-value">${data.disco}%</div>
            </div>
            <div class="status-card">
              <div class="status-label">Servidor</div>
              <div class="status-value">${data.status_servidor}</div>
            </div>
          `;
          
          html += `
            <div class="status-card">
              <div class="status-label">üå°Ô∏è Temperatura CPU</div>
              <div class="status-value">${data.cpu_temperatura !== "N/A" ? data.cpu_temperatura + "¬∞C" : "N/A"}</div>
            </div>
          `;
          
          html += `
            <div class="status-card">
              <div class="status-label">‚ö° Frequ√™ncia RAM</div>
              <div class="status-value">${data.ram_frequencia !== "N/A" ? data.ram_frequencia + " MHz" : "N/A"}</div>
            </div>
          `;
          
          if (data.ram_energia && data.ram_energia.total_watts !== "N/A") {
            html += `
              <div class="status-card">
                <div class="status-label">üîã Energia RAM</div>
                <div class="status-value">${data.ram_energia.total_watts}W</div>
              </div>
            `;
          } else {
            html += `
              <div class="status-card">
                <div class="status-label">üîã Energia RAM</div>
                <div class="status-value">N/A</div>
              </div>
            `;
          }
          
          if (data.bateria && data.bateria !== "N/A") {
            const statusBateria = data.bateria.plugged ? "üîå Conectado" : "üîã Bateria";
            let tempoRestante = "";
            if (data.bateria.time_left && data.bateria.time_left > 0) {
              const minutos = Math.floor(data.bateria.time_left / 60);
              tempoRestante = `<br><small style="font-size: 14px;">${minutos} min restantes</small>`;
            }
            html += `
              <div class="status-card">
                <div class="status-label">üîã Bateria</div>
                <div class="status-value">
                  ${data.bateria.percent}%<br>
                  <small style="font-size: 14px;">${statusBateria}</small>
                  ${tempoRestante}
                </div>
              </div>
            `;
          } else {
            html += `
              <div class="status-card">
                <div class="status-label">üîã Bateria</div>
                <div class="status-value">N/A<br><small style="font-size: 12px;">Desktop</small></div>
              </div>
            `;
          }
          
          document.getElementById('status-cards').innerHTML = html;
          document.getElementById('painel-status').style.display = 'block';
        });
      }

      if (tipo === 'logs') {
        fetch('/logs').then(res => res.text()).then(texto => {
          const linhas = texto.split('\n').filter(l => l.trim() !== '');
          document.getElementById('logs-list').innerHTML = linhas.map(l => `<li class="list-group-item">${l}</li>`).join('');
          document.getElementById('painel-logs').style.display = 'block';
        });
      }

      if (tipo === 'processos') {
        carregarProcessos('cpu');
        document.getElementById('painel-processos').style.display = 'block';
      }

      if (tipo === 'rede') {
        fetch('/rede').then(res => res.json()).then(dados => {
          let mostrarLocal = false;
          let mostrarPublico = false;

          const atualizarRede = () => {
            document.getElementById('rede-list').innerHTML = `
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>IP Local: <strong>${mostrarLocal ? dados.ip_local : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</strong></span>
                <button class="btn btn-sm btn-outline-secondary" onclick="alternarIPLocal()">
                  ${mostrarLocal ? 'üîí' : 'üëÅÔ∏è'}
                </button>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>IP P√∫blico: <strong>${mostrarPublico ? dados.ip_publico : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</strong></span>
                <button class="btn btn-sm btn-outline-secondary" onclick="alternarIPPublico()">
                  ${mostrarPublico ? 'üîí' : 'üëÅÔ∏è'}
                </button>
              </li>
              <li class="list-group-item">Enviado: ${dados.enviado} MB</li>
              <li class="list-group-item">Recebido: ${dados.recebido} MB</li>
            `;
          };

          window.alternarIPLocal = () => {
            mostrarLocal = !mostrarLocal;
            atualizarRede();
          };

          window.alternarIPPublico = () => {
            mostrarPublico = !mostrarPublico;
            atualizarRede();
          };

          atualizarRede();
          document.getElementById('painel-rede').style.display = 'block';
          iniciarGraficoRede();
        });
      }

      if (tipo === 'hardware') {
        fetch('/hardware').then(res => res.json()).then(dados => {
          document.getElementById('hardware-list').innerHTML = `
            <li class="list-group-item">Sistema: ${dados.sistema}</li>
            <li class="list-group-item">Vers√£o: ${dados.versao}</li>
            <li class="list-group-item">Arquitetura: ${dados.arquitetura}</li>
            <li class="list-group-item">Processador: ${dados.processador}</li>
            <li class="list-group-item">N√∫cleos F√≠sicos: ${dados.cpu_cores}</li>
            <li class="list-group-item">Threads L√≥gicas: ${dados.cpu_threads}</li>
            <li class="list-group-item">Mem√≥ria Total: ${dados.memoria_total} GB</li>
            <li class="list-group-item">Disco Total: ${dados.disco_total} GB</li>
          `;
          document.getElementById('painel-hardware').style.display = 'block';
        });
      }

      if (tipo === 'uptime') {
        fetch('/uptime').then(res => res.json()).then(dados => {
          document.getElementById('uptime-list').innerHTML = `
            <li class="list-group-item">Tempo Ativo: ${dados.horas}h ${dados.minutos}min</li>
            <li class="list-group-item">Iniciado em: ${dados.inicio}</li>
          `;
          document.getElementById('painel-uptime').style.display = 'block';
        });
      }
    }

    let redeChart = null;
    let ultimoEnviado = 0;
    let ultimoRecebido = 0;

    function iniciarGraficoRede() {
      if (redeChart) {
        redeChart.destroy();
      }

      const redeCtx = document.getElementById('redeChart').getContext('2d');
      redeChart = new Chart(redeCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Download (MB)',
              data: [],
              borderColor: 'rgb(75, 192, 192)',
              backgroundColor: 'rgba(75, 192, 192, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: true
            },
            {
              label: 'Upload (MB)',
              data: [],
              borderColor: 'rgb(255, 99, 132)',
              backgroundColor: 'rgba(255, 99, 132, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          animation: {
            duration: 500
          }
        }
      });

      ultimoEnviado = 0;
      ultimoRecebido = 0;
      atualizarGraficoRede();
      window.intervaloGraficoRede = setInterval(atualizarGraficoRede, 2000);
    }

    function atualizarGraficoRede() {
      fetch('/rede/historico')
        .then(response => response.json())
        .then(data => {
          if (data.erro) return;

          const agora = new Date().toLocaleTimeString('pt-BR');
          const downloadAtual = data.recebido;
          const uploadAtual = data.enviado;

          if (ultimoRecebido === 0) {
            ultimoRecebido = downloadAtual;
            ultimoEnviado = uploadAtual;
            return;
          }

          const taxaDownload = Math.max(0, (downloadAtual - ultimoRecebido)).toFixed(2);
          const taxaUpload = Math.max(0, (uploadAtual - ultimoEnviado)).toFixed(2);

          ultimoRecebido = downloadAtual;
          ultimoEnviado = uploadAtual;

          redeChart.data.labels.push(agora);
          redeChart.data.datasets[0].data.push(parseFloat(taxaDownload));
          redeChart.data.datasets[1].data.push(parseFloat(taxaUpload));

          if (redeChart.data.labels.length > 20) {
            redeChart.data.labels.shift();
            redeChart.data.datasets[0].data.shift();
            redeChart.data.datasets[1].data.shift();
          }

          redeChart.update('none');
        })
        .catch(error => console.error('Erro:', error));
    }

    function carregarProcessos(filtro = 'cpu') {
      document.querySelectorAll('.btn-filtro').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn-filtro-${filtro}`).classList.add('active');
      
      let url = '/processos';
      if (filtro === 'cpu') url = '/processos?filtro=cpu';
      if (filtro === 'memoria') url = '/processos?filtro=memoria';
      
      fetch(url).then(res => res.json()).then(lista => {
        if (!Array.isArray(lista) || lista.length === 0) {
          document.getElementById('processos-list').innerHTML = '<div class="alert alert-warning">Nenhum processo encontrado.</div>';
          document.getElementById('painel-processos').style.display = 'block';
          return;
        }
        document.getElementById('processos-list').innerHTML = lista.map(proc => {
          const cpuBadge = proc.cpu_percent > 10 ? '<span class="badge badge-cpu-high">Alto CPU</span>' : '';
          const memBadge = proc.memory_percent > 10 ? '<span class="badge badge-mem-high">Alta Mem</span>' : '';
          
          return `
            <div class="processo-item">
              <div class="processo-info">
                <div class="processo-nome">${proc.name}</div>
                <div class="processo-detalhes">
                  PID: ${proc.pid} | CPU: ${proc.cpu_percent}% | Mem√≥ria: ${proc.memory_percent.toFixed(1)}%
                  ${cpuBadge} ${memBadge}
                </div>
              </div>
              <div class="processo-grafico">
                <canvas id="chart-${proc.pid}"></canvas>
              </div>
              <button class="btn btn-sm btn-danger" onclick="encerrarProcesso(${proc.pid})">Encerrar</button>
            </div>
          `;
        }).join('');
        
        lista.forEach(proc => {
          renderizarGraficoProcesso(proc.pid, proc.cpu_percent, proc.memory_percent);
        });
        
        document.getElementById('painel-processos').style.display = 'block';
      })
      .catch(err => {
        console.error('Erro ao carregar processos:', err);
        document.getElementById('processos-list').innerHTML = '<div class="alert alert-danger">Erro ao carregar processos.</div>';
        document.getElementById('painel-processos').style.display = 'block';
      });
    }

    function renderizarGraficoProcesso(pid, cpu, mem) {
      const canvas = document.getElementById(`chart-${pid}`);
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      
      const cpuColor = cpu > 50 ? '#dc3545' : (cpu > 20 ? '#fd7e14' : '#0d6efd');
      const memColor = mem > 50 ? '#dc3545' : (mem > 20 ? '#ffc107' : '#198754');
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['CPU %', 'MEM %'],
          datasets: [{
            label: `Processo ${pid}`,
            data: [cpu, mem],
            backgroundColor: [cpuColor, memColor],
            borderRadius: 4,
            borderWidth: 0
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              beginAtZero: true,
              max: 100,
              grid: { color: 'rgba(0,0,0,0.05)' },
              ticks: { font: { weight: 'bold' } }
            },
            y: {
              grid: { display: false },
              ticks: { font: { weight: 'bold' } }
            }
          }
        }
      });
    }

    function filtrarProcessos(filtro) {
      carregarProcessos(filtro);
    }

    function encerrarProcesso(pid) {
      fetch('/encerrar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pid: pid })
      })
      .then(res => res.json())
      .then(resp => {
        if (resp.status === "encerrado") {
          alert(`‚úÖ Processo ${resp.pid} encerrado com sucesso!`);
        } else {
          alert(`‚ö†Ô∏è Erro ao encerrar processo: ${resp.mensagem}`);
        }
        carregarProcessos('todos');
      });
    }
  </script>
</body>
</html>